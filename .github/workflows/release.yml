name: GitHub Release

on:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for proper changelog generation

      - name: Get previous tag
        id: previoustag
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | sed -n '2p')
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"

      - name: Extract fixed issues from PRs
        id: extract_issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all merged PRs since the previous tag
          if [ -n "${{ steps.previoustag.outputs.previous_tag }}" ]; then
            PREVIOUS_TAG="${{ steps.previoustag.outputs.previous_tag }}"
          else
            # If no previous tag, use first commit
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          # Get commits between previous tag and current tag
          COMMITS=$(git log ${PREVIOUS_TAG}...${{ github.ref_name }} --oneline --pretty=format:"%s")

          # Extract issue numbers from commit messages (fixes #123, closes #456, resolves #789, etc.)
          ISSUES=$(echo "$COMMITS" | grep -oiE '(fix(es|ed)?|close(s|d)?|resolve(s|d)?) #[0-9]+' | grep -oE '#[0-9]+' | sed 's/#//' | sort -u || true)

          # Also get PRs merged in this range and extract issues from PR bodies
          PR_NUMBERS=$(git log ${PREVIOUS_TAG}...${{ github.ref_name }} --oneline --pretty=format:"%s" | grep -oE '#[0-9]+' | sed 's/#//' | sort -u || true)

          for PR in $PR_NUMBERS; do
            # Get PR body and extract issue references
            PR_ISSUES=$(gh pr view $PR --json body --jq '.body' 2>/dev/null | grep -oiE '(fix(es|ed)?|close(s|d)?|resolve(s|d)?) #[0-9]+' | grep -oE '#[0-9]+' | sed 's/#//' || true)
            ISSUES=$(echo -e "$ISSUES\n$PR_ISSUES" | sort -u)
          done

          # Remove empty lines
          ISSUES=$(echo "$ISSUES" | grep -v '^$' || true)

          echo "Fixed issues: $ISSUES"
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Close fixed issues
        if: steps.extract_issues.outputs.issues != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUES="${{ steps.extract_issues.outputs.issues }}"

          for ISSUE in $ISSUES; do
            # Check if issue exists and is open
            STATE=$(gh issue view $ISSUE --json state --jq '.state' 2>/dev/null || echo "not_found")

            if [ "$STATE" = "OPEN" ]; then
              echo "Closing issue #$ISSUE"
              gh issue close $ISSUE --comment "Automatically closed by release ${{ github.ref_name }}"
            else
              echo "Issue #$ISSUE is already closed or not found"
            fi
          done
